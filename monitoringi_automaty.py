# -*- coding: utf-8 -*-
"""Soczyste rabaty.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1bfU5lwdNa2GOPWmQ9-URaf30VnlBzQC0
"""

#importowanie potrzebnych bibliotek
import os
import openpyxl
import streamlit as st
import pandas as pd
import numpy as np
import altair as alt
import plotly.express as px
import plotly.graph_objects as go
from urllib.request import urlopen
import json
import io
import datetime



st.set_page_config(page_title='Monitoringi AUTOMATY', layout='wide')


sekcja = st.sidebar.radio(
    'Wybierz monitoring:',
    ('Wsparcie z natury','Cykl Q4','Genoptim')
 )

tabs_font_css = """
<style>
div[class*="stTextInput"] label {
  font-size: 26px;
  color: black;
}
div[class*="stSelectbox"] label {
  font-size: 26px;
  color: black;
}
</style>
"""
#POTRZEBNE FUNKCJE
#1 Funkcja do wyodrębnienia wartości procentowej
def extract_percentage(text):
    import re
    match = re.search(r'(\d+,\d+|\d+)%', text)
    return match.group(0) if match else ''

#2 Funkcja do konwersji wartości procentowej na float
def percentage_to_float(percentage_str):
    if pd.isna(percentage_str) or not percentage_str:
        return 0.0  # Zmieniono na 0.0, aby brakujące wartości były traktowane jako 0
    # Zamiana przecinka na kropkę, usunięcie znaku '%'
    return float(percentage_str.replace(',', '.').replace('%', ''))


dzisiejsza_data = datetime.datetime.now().strftime("%d.%m.%Y")


 


############################################################################### WSPARCIE Z NATURY  ##############################################################################################
if sekcja == 'Wsparcie z natury':
    st.write(tabs_font_css, unsafe_allow_html=True)

    df = st.file_uploader(
        label = "Wrzuć plik Cykl - Wsparcie z natury"
    )
    if df:
        df = pd.read_excel(df, sheet_name = 'Promocje na utrzymanie', skiprows = 19, usecols = [1, 9])
        st.write(df.head())


    #usuń braki danych z Kod klienta
    df = df.dropna(subset=['KLIENT'])

    # klient na całkowite
    df['KLIENT'] = df['KLIENT'].astype(int)

    
    # Zmiana nazw kolumn
    df = df.rename(columns={'0.15.1': '15'})

    # Dodaj kolumnę 'SIECIOWY', która będzie zawierać 'SIECIOWY' jeśli w kolumnach '12' lub '14' jest słowo 'powiązanie'
    df['SIECIOWY'] = df.apply(lambda row: 'SIECIOWY' if 'powiązanie' in str(row['15']).lower() else '', axis=1)

    #SPRAWDZENIE CZY DZIAŁA
    #df[df['SIECIOWY'] == 'SIECIOWY']
    #DZIAŁA :)

    
    # Zastosowanie funkcji do kolumn '12' i '14'
    df['15_percent'] = df['15'].apply(extract_percentage)


    # Konwersja kolumn '12_percent' i '14_percent' na liczby zmiennoprzecinkowe
    df['15_percent'] = df['15_percent'].apply(percentage_to_float)
    df = df.rename(columns={'15_percent':'max_percent'})


    # Wybierz wiersze, gdzie 'max_percent' nie jest równa 0
    filtered_df = df[df['max_percent'] != 0]

    standard = filtered_df[filtered_df['SIECIOWY'] != 'SIECIOWY']
    
    powiazanie = filtered_df[filtered_df['SIECIOWY'] == 'SIECIOWY']
    #len(standard), len(powiazanie), len(filtered_df)

    # Dodanie kolumny "CZY_OK", sprawdzającej długość tekstu
    powiazanie['KLIENT_S'] = powiazanie['KLIENT'].apply(lambda x: x if len(str(x)) == 5 else '')
    #powiazanie

    dane1 = powiazanie[powiazanie['KLIENT_S'].notna() & (powiazanie['KLIENT_S'] != '')]
    #dane1
    dane2 = powiazanie[powiazanie['KLIENT_S'].isna() | (powiazanie['KLIENT_S'] == '')]
    dane2 = dane2.rename(columns={'KLIENT':'Kod klienta'})
    #dane2
    #dane2.shape


    ######################################################### TERAZ IMS
    ims = st.file_uploader(
        label = "Wrzuć plik ims_nhd"
    )

    if ims:
        ims = pd.read_excel(ims, usecols=[0,2,19,21])
        st.write(ims.head())

    ims = ims[ims['APD_Czy_istnieje_na_rynku']==1]
    ims = ims[ims['APD_Rodzaj_farmaceutyczny'].isin(['AP - Apteka','ME - Sklep zielarsko - medyczny','PU - Punkt apteczny'])]

    #dane1 czyli te co są tylko kody sieciowe
    wynik_df = pd.merge(dane1, ims, left_on='KLIENT', right_on='Klient', how='left')

    # Wybór potrzebnych kolumn: 'APD_kod_SAP_apteki' i 'max_percent'
    wynik_df = wynik_df[['KLIENT','APD_kod_SAP_apteki', 'max_percent']]


    #to są kody SAP
    wynik_df1 = wynik_df.rename(columns={'APD_kod_SAP_apteki': 'Kod klienta'})
    wynik_df1 = wynik_df1[['Kod klienta','max_percent']]
    #wynik_df1
    #wynik_df1.shape

    #to są kody powiazan
    wynik_df2 = wynik_df.rename(columns={'KLIENT': 'Kod klienta'})
    wynik_df2 = wynik_df2[['Kod klienta','max_percent']]
    #wynik_df2
    #wynik_df2.shape

    #POŁĄCZYĆ wynik_df z standard_ost
    polaczone = pd.concat([wynik_df1, wynik_df2], axis = 0)
    posortowane = polaczone.sort_values(by='max_percent', ascending=False)
    ostatecznie1 = posortowane.drop_duplicates(subset='Kod klienta')
    #ostatecznie1

    dane2 = dane2[['Kod klienta','max_percent']]

    ostateczne = pd.concat([ostatecznie1, dane2], axis = 0)
    ostateczne = ostateczne.sort_values(by='max_percent', ascending=False)
    ostateczne = ostateczne.drop_duplicates(subset='Kod klienta')
    #ostateczne.shape

    

    st.write('Jeśli to pierwszy monitoring, pobierz ten plik, jeśli nie, wrzuć plik z poprzedniego monitoringu i NIE POBIERAJ TEGO PLIKU')
    excel_file = io.BytesIO()
    with pd.ExcelWriter(excel_file, engine='xlsxwriter') as writer:
        ostateczne.to_excel(writer, index=False, sheet_name='Sheet1')
    excel_file.seek(0)  # Resetowanie wskaźnika do początku pliku

    # Umożliwienie pobrania pliku Excel
    st.download_button(
        label='Pobierz, jeśli to pierwszy monitoring',
        data=excel_file,
        file_name='czy_dodac.xlsx',
        mime='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    )

    #plik z poprzedniego monitoringu
    poprzedni = st.file_uploader(
        label = "Wrzuć plik z poprzedniego monitoringu"
    )

    if poprzedni:
        poprzedni = pd.read_excel(poprzedni)
        st.write(poprzedni.head())

    poprzedni = poprzedni.rename(columns={'max_percent': 'old_percent'})
    # Wykonanie left join, dodanie 'old_percent' do pliku 'ostatecznie'
    result = ostateczne.merge(poprzedni[['Kod klienta', 'old_percent']], on='Kod klienta', how='left')
    result['old_percent'] = result['old_percent'].fillna(0)
    result['Czy dodać'] = result.apply(lambda row: 'DODAJ' if row['max_percent'] > row['old_percent'] else '', axis=1)
    st.write('Kliknij aby pobrać plik z kodami, które kody należy dodać')

    excel_file1 = io.BytesIO()
    with pd.ExcelWriter(excel_file1, engine='xlsxwriter') as writer:
        result.to_excel(writer, index=False, sheet_name='Sheet1')
    excel_file1.seek(0)  # Resetowanie wskaźnika do początku pliku

    nazwa_pliku1 = f"WSPARCIE_Z_NATURY_{dzisiejsza_data}.xlsx"
    # Umożliwienie pobrania pliku Excel
    st.download_button(
        label='Pobierz',
        data=excel_file1,
        file_name=nazwa_pliku1,
        mime='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    )

    result = result.drop(columns=['old_percent', 'Czy dodać'])


    st.write('Kliknij, aby pobrać plik z formułą max do następnego monitoringu')
    excel_file2 = io.BytesIO()
    with pd.ExcelWriter(excel_file2, engine='xlsxwriter') as writer:
        result.to_excel(writer, index=False, sheet_name='Sheet1')
    excel_file1.seek(0)  # Resetowanie wskaźnika do początku pliku

    nazwa_pliku = f"FM_WSPARCIE_Z_NATURY_{dzisiejsza_data}.xlsx"
    # Umożliwienie pobrania pliku Excel
    st.download_button(
        label='Pobierz nowy plik FORMUŁA MAX',
        data=excel_file2,
        file_name = nazwa_pliku,
        mime='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    )


############################################################################### CYKL 4Q  ##############################################################################################
if sekcja == 'Cykl Q4':
    st.write(tabs_font_css, unsafe_allow_html=True)

    df = st.file_uploader(
        label = "Wrzuć plik Cykl - Cykl Q4"
    )
    if df:
        df = pd.read_excel(df, sheet_name = 'Promocje na utrzymanie i FUS', skiprows = 15, usecols = [1,2,9,10])
        st.write(df.head())


    #usuń braki danych z Kod klienta
    df = df.dropna(subset=['Kod klienta'])

    # klient na całkowite
    df['KLIENT'] = df['KLIENT'].astype(int)
    df['Kod klienta'] = df['Kod klienta'].astype(int)

    # Zmiana nazw kolumn
    df = df.rename(columns={'0.12.1': '12', '0.14.1': '14'})

    # Dodaj kolumnę 'SIECIOWY', która będzie zawierać 'SIECIOWY' jeśli w kolumnach '12' lub '14' jest słowo 'powiązanie'
    df['SIECIOWY'] = df.apply(lambda row: 'SIECIOWY' if 'powiązanie' in str(row['12']).lower() or 'powiązanie' in str(row['14']).lower() else '', axis=1)

    #SPRAWDZENIE CZY DZIAŁA
    #df[df['SIECIOWY'] == 'SIECIOWY']
    #DZIAŁA :)

    
    # Zastosowanie funkcji do kolumn '12' i '14'
    df['12_percent'] = df['12'].apply(extract_percentage)
    df['14_percent'] = df['14'].apply(extract_percentage)


    # Konwersja kolumn '12_percent' i '14_percent' na liczby zmiennoprzecinkowe
    df['12_percent'] = df['12_percent'].apply(percentage_to_float)
    df['14_percent'] = df['14_percent'].apply(percentage_to_float)

    # Dodaj nową kolumnę 'max_percent' z maksymalnymi wartościami z kolumn '12_percent' i '14_percent'
    df['max_percent'] = df[['12_percent', '14_percent']].max(axis=1)

    # Wybierz wiersze, gdzie 'max_percent' nie jest równa 0
    filtered_df = df[df['max_percent'] != 0]

    standard = filtered_df[filtered_df['SIECIOWY'] != 'SIECIOWY']
    powiazanie = filtered_df[filtered_df['SIECIOWY'] == 'SIECIOWY']

    #len(standard), len(powiazanie), len(filtered_df)

    standard_ost = standard[['Kod klienta', 'max_percent']]

    powiazanie = powiazanie[['KLIENT','Kod klienta','max_percent']]


    #TERAZ IMS
    ims = st.file_uploader(
        label = "Wrzuć plik ims_nhd"
    )

    if ims:
        ims = pd.read_excel(ims, usecols=[0,2,19,21])
        st.write(ims.head())

    ims = ims[ims['APD_Czy_istnieje_na_rynku']==1]
    ims = ims[ims['APD_Rodzaj_farmaceutyczny'].isin(['AP - Apteka','ME - Sklep zielarsko - medyczny','PU - Punkt apteczny'])]

    wynik_df = pd.merge(powiazanie, ims, left_on='KLIENT', right_on='Klient', how='left')

    # Wybór potrzebnych kolumn: 'APD_kod_SAP_apteki' i 'max_percent'
    wynik_df = wynik_df[['KLIENT','APD_kod_SAP_apteki', 'max_percent']]


    #to są kody SAP
    wynik_df1 = wynik_df.rename(columns={'APD_kod_SAP_apteki': 'Kod klienta'})
    wynik_df1 = wynik_df1[['Kod klienta','max_percent']]
    #wynik_df1

    #to są kody powiazan
    wynik_df2 = wynik_df.rename(columns={'KLIENT': 'Kod klienta'})
    wynik_df2 = wynik_df2[['Kod klienta','max_percent']]
    #wynik_df2

    #POŁĄCZYĆ wynik_df z standard_ost
    polaczone = pd.concat([standard_ost, wynik_df1, wynik_df2], axis = 0)
  
    posortowane = polaczone.sort_values(by='max_percent', ascending=False)

    ostatecznie = posortowane.drop_duplicates(subset='Kod klienta')


    st.write('Jeśli to pierwszy monitoring, pobierz ten plik, jeśli nie, wrzuć plik z poprzedniego monitoringu i NIE POBIERAJ TEGO PLIKU')
    excel_file = io.BytesIO()
    with pd.ExcelWriter(excel_file, engine='xlsxwriter') as writer:
        ostatecznie.to_excel(writer, index=False, sheet_name='Sheet1')
    excel_file.seek(0)  # Resetowanie wskaźnika do początku pliku

    # Umożliwienie pobrania pliku Excel
    st.download_button(
        label='Pobierz, jeśli to pierwszy monitoring',
        data=excel_file,
        file_name='czy_dodac.xlsx',
        mime='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    )

    #plik z poprzedniego monitoringu
    poprzedni = st.file_uploader(
        label = "Wrzuć plik z poprzedniego monitoringu"
    )

    if poprzedni:
        poprzedni = pd.read_excel(poprzedni)
        st.write(poprzedni.head())

    poprzedni = poprzedni.rename(columns={'max_percent': 'old_percent'})
    # Wykonanie left join, dodanie 'old_percent' do pliku 'ostatecznie'
    result = ostatecznie.merge(poprzedni[['Kod klienta', 'old_percent']], on='Kod klienta', how='left')
    result['old_percent'] = result['old_percent'].fillna(0)
    result['Czy dodać'] = result.apply(lambda row: 'DODAJ' if row['max_percent'] > row['old_percent'] else '', axis=1)
    st.write('Kliknij aby pobrać plik z kodami, które kody należy dodać')

    excel_file1 = io.BytesIO()
    with pd.ExcelWriter(excel_file1, engine='xlsxwriter') as writer:
        result.to_excel(writer, index=False, sheet_name='Sheet1')
    excel_file1.seek(0)  # Resetowanie wskaźnika do początku pliku

    nazwa_pliku1 = f"CYKL_Q4_{dzisiejsza_data}.xlsx"
    # Umożliwienie pobrania pliku Excel
    st.download_button(
        label='Pobierz',
        data=excel_file1,
        file_name=nazwa_pliku1,
        mime='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    )

    result = result.drop(columns=['old_percent', 'Czy dodać'])


    st.write('Kliknij, aby pobrać plik z formułą max do następnego monitoringu')
    excel_file2 = io.BytesIO()
    with pd.ExcelWriter(excel_file2, engine='xlsxwriter') as writer:
        result.to_excel(writer, index=False, sheet_name='Sheet1')
    excel_file1.seek(0)  # Resetowanie wskaźnika do początku pliku

    nazwa_pliku = f"FM_CYKL_Q4_{dzisiejsza_data}.xlsx"
    # Umożliwienie pobrania pliku Excel
    st.download_button(
        label='Pobierz nowy plik FORMUŁA MAX',
        data=excel_file2,
        file_name = nazwa_pliku,
        mime='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    )



############################################################################ GENOPTIM #################################################################
if sekcja == 'Genoptim':
    st.write(tabs_font_css, unsafe_allow_html=True)

    df = st.file_uploader(
        label="Wrzuć plik Cykl - Genoptim"
    )
    
    if df:
        # Pobieramy listę dostępnych arkuszy
        xls = pd.ExcelFile(df)
        
        # Sprawdzamy, które arkusze są dostępne i wczytujemy odpowiednie dane
        if 'BRAZOFLAMIN' in xls.sheet_names:
            BRAZOFLAMIN = pd.read_excel(df, sheet_name='BRAZOFLAMIN', skiprows=18, usecols=[1, 8])
            st.write("Dane z arkusza BRAZOFLAMIN:")
            st.write(BRAZOFLAMIN.head())

        if 'DIAZEPAM' in xls.sheet_names:
            DIAZEPAM = pd.read_excel(df, sheet_name='DIAZEPAM', skiprows=18, usecols=[1, 8])
            st.write("Dane z arkusza DIAZEPAM:")
            st.write(DIAZEPAM.head())

        if 'ESCITALOPRAM' in xls.sheet_names:
            ESCITALOPRAM = pd.read_excel(df, sheet_name='ESCITALOPRAM', skiprows=18, usecols=[1, 8])
            st.write("Dane z arkusza ESCITALOPRAM:")
            st.write(ESCITALOPRAM.head())

        if 'LEVOFLOXACIN GENOPTIM 500MG ' in xls.sheet_names:
            LEVOFLOXACIN = pd.read_excel(df, sheet_name='LEVOFLOXACIN GENOPTIM 500MG ', skiprows=18, usecols=[1, 8])
            st.write("Dane z arkusza LEVOFLOXACIN GENOPTIM 500MG :")
            st.write(LEVOFLOXACIN.head())

        if 'LEVOFLOXACIN GENOPTIM KR.5MG' in xls.sheet_names:
            LEVOFLOXACIN1 = pd.read_excel(df, sheet_name='LEVOFLOXACIN GENOPTIM KR.5MG', skiprows=18, usecols=[1, 8])
            st.write("Dane z arkusza LEVOFLOXACIN GENOPTIM KR.5MG:")
            st.write(LEVOFLOXACIN1.head())
            
        if 'RUPATADINE' in xls.sheet_names:
            RUPATADINE = pd.read_excel(df, sheet_name='RUPATADINE', skiprows=18, usecols=[1, 8])
            st.write("Dane z arkusza RUPATADINE:")
            st.write(RUPATADINE.head())

        if 'SILDENAFIL' in xls.sheet_names:
            SILDENAFIL = pd.read_excel(df, sheet_name='SILDENAFIL', skiprows=18, usecols=[1, 8])
            st.write("Dane z arkusza SILDENAFIL:")
            st.write(SILDENAFIL.head())

        if 'TADAXIN  5MG' in xls.sheet_names:
            TADAXIN = pd.read_excel(df, sheet_name='TADAXIN  5MG', skiprows=18, usecols=[1, 8])
            st.write("Dane z arkusza TADAXIN  5MG:")
            st.write(TADAXIN.head())

        if 'TADAXIN 20MG' in xls.sheet_names:
            TADAXIN1 = pd.read_excel(df, sheet_name='TADAXIN 20MG', skiprows=18, usecols=[1, 8])
            st.write("Dane z arkusza TADAXIN 20MG:")
            st.write(TADAXIN1.head())

        if 'ZOLPIDEM GENOPTIM 10MG 20TABL.' in xls.sheet_names:
            ZOLPIDEM = pd.read_excel(df, sheet_name='ZOLPIDEM GENOPTIM 10MG 20TABL.', skiprows=18, usecols=[1, 8])
            st.write("Dane z arkusza ZOLPIDEM GENOPTIM 10MG 20TABL.:")
            st.write(ZOLPIDEM.head())

        if 'ZOLPIDEM 10MG 30TABL.' in xls.sheet_names:
            ZOLPIDEM1 = pd.read_excel(df, sheet_name='ZOLPIDEM 10MG 30TABL.', skiprows=18, usecols=[1, 8])
            st.write("Dane z arkusza ZOLPIDEM GENOPTIM 10MG 20TABL.:")
            st.write(ZOLPIDEM1.head())


    #usuń braki danych z Kod klienta
    BRAZOFLAMIN = BRAZOFLAMIN.dropna(subset=['KLIENT']) 
    DIAZEPAM = DIAZEPAM.dropna(subset=['KLIENT'])
    ESCITALOPRAM = ESCITALOPRAM.dropna(subset=['KLIENT'])
    LEVOFLOXACIN = LEVOFLOXACIN.dropna(subset=['KLIENT'])
    LEVOFLOXACIN1 = LEVOFLOXACIN1.dropna(subset=['KLIENT'])
    RUPATADINE = RUPATADINE.dropna(subset=['KLIENT'])
    SILDENAFIL = SILDENAFIL.dropna(subset=['KLIENT'])
    TADAXIN = TADAXIN.dropna(subset=['KLIENT'])
    TADAXIN1 = TADAXIN1.dropna(subset=['KLIENT'])
    ZOLPIDEM = ZOLPIDEM.dropna(subset=['KLIENT'])
    ZOLPIDEM1 = ZOLPIDEM1.dropna(subset=['KLIENT'])


    # klient na całkowite
    BRAZOFLAMIN['KLIENT'] = BRAZOFLAMIN['KLIENT'].astype(int)
    DIAZEPAM['KLIENT'] = DIAZEPAM['KLIENT'].astype(int)
    ESCITALOPRAM['KLIENT'] = ESCITALOPRAM['KLIENT'].astype(int)
    LEVOFLOXACIN['KLIENT'] = LEVOFLOXACIN['KLIENT'].astype(int)
    LEVOFLOXACIN1['KLIENT'] = LEVOFLOXACIN1['KLIENT'].astype(int)
    RUPATADINE['KLIENT'] = RUPATADINE['KLIENT'].astype(int)
    SILDENAFIL['KLIENT'] = SILDENAFIL['KLIENT'].astype(int)
    TADAXIN['KLIENT'] = TADAXIN['KLIENT'].astype(int)
    TADAXIN1['KLIENT'] = TADAXIN1['KLIENT'].astype(int)
    ZOLPIDEM['KLIENT'] = ZOLPIDEM['KLIENT'].astype(int)
    ZOLPIDEM1['KLIENT'] = ZOLPIDEM1['KLIENT'].astype(int)


    # Usuwanie wierszy, gdzie w kolumnie 'pakiet' znajduje się słowo 'brak'
    BRAZOFLAMIN = BRAZOFLAMIN[BRAZOFLAMIN['pakiet'] != 'brak']
    DIAZEPAM = DIAZEPAM[DIAZEPAM['pakiet'] != 'brak']
    ESCITALOPRAM = ESCITALOPRAM[ESCITALOPRAM['pakiet'] != 'brak']
    LEVOFLOXACIN = LEVOFLOXACIN[LEVOFLOXACIN['pakiet'] != 'brak']
    LEVOFLOXACIN1 = LEVOFLOXACIN1[LEVOFLOXACIN1['pakiet'] != 'brak']
    RUPATADINE = RUPATADINE[RUPATADINE['pakiet'] != 'brak']
    SILDENAFIL = SILDENAFIL[SILDENAFIL['pakiet'] != 'brak']
    TADAXIN = TADAXIN[TADAXIN['pakiet'] != 'brak']
    TADAXIN1 = TADAXIN1[TADAXIN1['pakiet'] != 'brak']
    ZOLPIDEM = ZOLPIDEM[ZOLPIDEM['pakiet'] != 'brak']
    ZOLPIDEM1 = ZOLPIDEM1[ZOLPIDEM1['pakiet'] != 'brak']
 
    
    # Dodaj kolumnę 'SIECIOWY', która będzie zawierać 'SIECIOWY'
    BRAZOFLAMIN['SIECIOWY'] = 'SIECIOWY'
    DIAZEPAM['SIECIOWY'] = 'SIECIOWY'
    ESCITALOPRAM['SIECIOWY'] = 'SIECIOWY'
    LEVOFLOXACIN['SIECIOWY'] = 'SIECIOWY'
    LEVOFLOXACIN1['SIECIOWY'] = 'SIECIOWY'
    RUPATADINE['SIECIOWY'] = 'SIECIOWY'
    SILDENAFIL['SIECIOWY'] = 'SIECIOWY'
    TADAXIN['SIECIOWY'] = 'SIECIOWY'
    TADAXIN1['SIECIOWY'] = 'SIECIOWY'
    ZOLPIDEM['SIECIOWY'] = 'SIECIOWY'
    ZOLPIDEM1['SIECIOWY'] = 'SIECIOWY'

    
    # Zastosowanie funkcji do kolumn '12' i '14'
    BRAZOFLAMIN['max_percent'] = BRAZOFLAMIN['pakiet'].apply(extract_percentage)
    DIAZEPAM['max_percent'] = DIAZEPAM['pakiet'].apply(extract_percentage)
    ESCITALOPRAM['max_percent'] = ESCITALOPRAM['pakiet'].apply(extract_percentage)
    LEVOFLOXACIN['max_percent'] = LEVOFLOXACIN['pakiet'].apply(extract_percentage)
    LEVOFLOXACIN1['max_percent'] = LEVOFLOXACIN1['pakiet'].apply(extract_percentage)
    RUPATADINE['max_percent'] = RUPATADINE['pakiet'].apply(extract_percentage)
    SILDENAFIL['max_percent'] = SILDENAFIL['pakiet'].apply(extract_percentage)
    TADAXIN['max_percent'] = TADAXIN['pakiet'].apply(extract_percentage)
    TADAXIN1['max_percent'] = TADAXIN1['pakiet'].apply(extract_percentage)
    ZOLPIDEM['max_percent'] = ZOLPIDEM['pakiet'].apply(extract_percentage)
    ZOLPIDEM1['max_percent'] = ZOLPIDEM1['pakiet'].apply(extract_percentage)



    # Konwersja kolumny percent na liczby zmiennoprzecinkowe
    BRAZOFLAMIN['max_percent'] = BRAZOFLAMIN['max_percent'].apply(percentage_to_float)
    DIAZEPAM['max_percent'] = DIAZEPAM['max_percent'].apply(percentage_to_float)
    ESCITALOPRAM['max_percent'] = ESCITALOPRAM['max_percent'].apply(percentage_to_float)
    LEVOFLOXACIN['max_percent'] = LEVOFLOXACIN['max_percent'].apply(percentage_to_float)
    LEVOFLOXACIN1['max_percent'] = LEVOFLOXACIN1['max_percent'].apply(percentage_to_float)
    RUPATADINE['max_percent'] = RUPATADINE['max_percent'].apply(percentage_to_float)
    SILDENAFIL['max_percent'] = SILDENAFIL['max_percent'].apply(percentage_to_float)
    TADAXIN['max_percent'] = TADAXIN['max_percent'].apply(percentage_to_float)
    TADAXIN1['max_percent'] = TADAXIN1['max_percent'].apply(percentage_to_float)
    ZOLPIDEM['max_percent'] = ZOLPIDEM['max_percent'].apply(percentage_to_float)
    ZOLPIDEM1['max_percent'] = ZOLPIDEM1['max_percent'].apply(percentage_to_float)


    # Wybierz wiersze, gdzie 'max_percent' nie jest równa 0
    BRAZOFLAMIN = BRAZOFLAMIN[BRAZOFLAMIN['max_percent'] != 0]
    DIAZEPAM = DIAZEPAM[DIAZEPAM['max_percent'] != 0]
    ESCITALOPRAM = ESCITALOPRAM[ESCITALOPRAM['max_percent'] != 0]
    LEVOFLOXACIN = LEVOFLOXACIN[LEVOFLOXACIN['max_percent'] != 0]
    LEVOFLOXACIN1 = LEVOFLOXACIN1[LEVOFLOXACIN1['max_percent'] != 0]
    RUPATADINE = RUPATADINE[RUPATADINE['max_percent'] != 0]
    SILDENAFIL = SILDENAFIL[SILDENAFIL['max_percent'] != 0]
    TADAXIN = TADAXIN[TADAXIN['max_percent'] != 0]
    TADAXIN1 = TADAXIN1[TADAXIN1['max_percent'] != 0]
    ZOLPIDEM = ZOLPIDEM[ZOLPIDEM['max_percent'] != 0]
    ZOLPIDEM1 = ZOLPIDEM1[ZOLPIDEM1['max_percent'] != 0]


    BRAZOFLAMIN = BRAZOFLAMIN[BRAZOFLAMIN['SIECIOWY'] == 'SIECIOWY']
    DIAZEPAM = DIAZEPAM[DIAZEPAM['SIECIOWY'] == 'SIECIOWY']
    ESCITALOPRAM = ESCITALOPRAM[ESCITALOPRAM['SIECIOWY'] == 'SIECIOWY']
    LEVOFLOXACIN = LEVOFLOXACIN[LEVOFLOXACIN['SIECIOWY'] == 'SIECIOWY']
    LEVOFLOXACIN1 = LEVOFLOXACIN1[LEVOFLOXACIN1['SIECIOWY'] == 'SIECIOWY']
    RUPATADINE = RUPATADINE[RUPATADINE['SIECIOWY'] == 'SIECIOWY']
    SILDENAFIL = SILDENAFIL[SILDENAFIL['SIECIOWY'] == 'SIECIOWY']
    TADAXIN = TADAXIN[TADAXIN['SIECIOWY'] == 'SIECIOWY']
    TADAXIN1 = TADAXIN1[TADAXIN1['SIECIOWY'] == 'SIECIOWY']
    ZOLPIDEM = ZOLPIDEM[ZOLPIDEM['SIECIOWY'] == 'SIECIOWY']
    ZOLPIDEM1 = ZOLPIDEM1[ZOLPIDEM1['SIECIOWY'] == 'SIECIOWY']


    BRAZOFLAMIN = BRAZOFLAMIN[['KLIENT', 'max_percent']]
    DIAZEPAM = DIAZEPAM[['KLIENT', 'max_percent']]
    ESCITALOPRAM = ESCITALOPRAM[['KLIENT', 'max_percent']]
    LEVOFLOXACIN = LEVOFLOXACIN[['KLIENT', 'max_percent']]
    LEVOFLOXACIN1 = LEVOFLOXACIN1[['KLIENT', 'max_percent']]
    RUPATADINE = RUPATADINE[['KLIENT', 'max_percent']]
    SILDENAFIL = SILDENAFIL[['KLIENT', 'max_percent']]
    TADAXIN = TADAXIN[['KLIENT', 'max_percent']]
    TADAXIN1 = TADAXIN1[['KLIENT', 'max_percent']]
    ZOLPIDEM = ZOLPIDEM[['KLIENT', 'max_percent']]
    ZOLPIDEM1 = ZOLPIDEM1[['KLIENT', 'max_percent']]


    #TERAZ IMS
    ims = st.file_uploader(
        label = "Wrzuć plik ims_nhd"
    )

    if ims:
        ims = pd.read_excel(ims, usecols=[0,2,19,21])
        st.write(ims.head())

    ims = ims[ims['APD_Czy_istnieje_na_rynku']==1]
    ims = ims[ims['APD_Rodzaj_farmaceutyczny'].isin(['AP - Apteka','ME - Sklep zielarsko - medyczny','PU - Punkt apteczny'])]


    wynik_B = pd.merge(BRAZOFLAMIN, ims, left_on='KLIENT', right_on='Klient', how='left')
    wynik_D = pd.merge(DIAZEPAM, ims, left_on='KLIENT', right_on='Klient', how='left')
    wynik_E = pd.merge(ESCITALOPRAM, ims, left_on='KLIENT', right_on='Klient', how='left')
    wynik_L = pd.merge(LEVOFLOXACIN, ims, left_on='KLIENT', right_on='Klient', how='left')
    wynik_LL = pd.merge(LEVOFLOXACIN1, ims, left_on='KLIENT', right_on='Klient', how='left')
    wynik_R = pd.merge(RUPATADINE, ims, left_on='KLIENT', right_on='Klient', how='left')
    wynik_S = pd.merge(SILDENAFIL, ims, left_on='KLIENT', right_on='Klient', how='left')
    wynik_T = pd.merge(TADAXIN, ims, left_on='KLIENT', right_on='Klient', how='left')
    wynik_TT = pd.merge(TADAXIN1, ims, left_on='KLIENT', right_on='Klient', how='left')
    wynik_Z = pd.merge(ZOLPIDEM, ims, left_on='KLIENT', right_on='Klient', how='left')
    wynik_ZZ = pd.merge(ZOLPIDEM1, ims, left_on='KLIENT', right_on='Klient', how='left')


    # Wybór potrzebnych kolumn: 'APD_kod_SAP_apteki' i 'max_percent'
    wynik_B = wynik_B[['KLIENT','APD_kod_SAP_apteki', 'max_percent']]
    wynik_D = wynik_D[['KLIENT','APD_kod_SAP_apteki', 'max_percent']]
    wynik_E = wynik_E[['KLIENT','APD_kod_SAP_apteki', 'max_percent']]
    wynik_L = wynik_L[['KLIENT','APD_kod_SAP_apteki', 'max_percent']]
    wynik_LL = wynik_LL[['KLIENT','APD_kod_SAP_apteki', 'max_percent']]
    wynik_R = wynik_R[['KLIENT','APD_kod_SAP_apteki', 'max_percent']]
    wynik_S = wynik_S[['KLIENT','APD_kod_SAP_apteki', 'max_percent']]
    wynik_T = wynik_T[['KLIENT','APD_kod_SAP_apteki', 'max_percent']]
    wynik_TT = wynik_TT[['KLIENT','APD_kod_SAP_apteki', 'max_percent']]
    wynik_Z = wynik_Z[['KLIENT','APD_kod_SAP_apteki', 'max_percent']]
    wynik_ZZ = wynik_ZZ[['KLIENT','APD_kod_SAP_apteki', 'max_percent']]
    
    
    #to są kody SAP
    wynik_B = wynik_B.rename(columns={'APD_kod_SAP_apteki': 'Kod klienta'})
    wynik_B = wynik_B[['Kod klienta','max_percent']]
    #wynik_df1

    wynik_D = wynik_D.rename(columns={'APD_kod_SAP_apteki': 'Kod klienta'})
    wynik_D = wynik_D[['Kod klienta','max_percent']]

    wynik_E = wynik_E.rename(columns={'APD_kod_SAP_apteki': 'Kod klienta'})
    wynik_E = wynik_E[['Kod klienta','max_percent']]

    wynik_L = wynik_L.rename(columns={'APD_kod_SAP_apteki': 'Kod klienta'})
    wynik_L = wynik_L[['Kod klienta','max_percent']]

    wynik_LL = wynik_LL.rename(columns={'APD_kod_SAP_apteki': 'Kod klienta'})
    wynik_LL = wynik_LL[['Kod klienta','max_percent']]

    wynik_R = wynik_R.rename(columns={'APD_kod_SAP_apteki': 'Kod klienta'})
    wynik_R = wynik_R[['Kod klienta','max_percent']]

    wynik_S = wynik_S.rename(columns={'APD_kod_SAP_apteki': 'Kod klienta'})
    wynik_S = wynik_S[['Kod klienta','max_percent']]

    wynik_T = wynik_T.rename(columns={'APD_kod_SAP_apteki': 'Kod klienta'})
    wynik_T = wynik_T[['Kod klienta','max_percent']]

    wynik_TT = wynik_TT.rename(columns={'APD_kod_SAP_apteki': 'Kod klienta'})
    wynik_TT = wynik_TT[['Kod klienta','max_percent']]

    wynik_Z = wynik_Z.rename(columns={'APD_kod_SAP_apteki': 'Kod klienta'})
    wynik_Z = wynik_Z[['Kod klienta','max_percent']]

    wynik_ZZ = wynik_ZZ.rename(columns={'APD_kod_SAP_apteki': 'Kod klienta'})
    wynik_ZZ = wynik_ZZ[['Kod klienta','max_percent']]

    #to są kody powiazan
    wynik_B1 = wynik_B.rename(columns={'KLIENT': 'Kod klienta'})
    wynik_B1 = wynik_B1[['Kod klienta','max_percent']]
    #wynik_df2

    wynik_D1 = wynik_D.rename(columns={'KLIENT': 'Kod klienta'})
    wynik_D1 = wynik_D1[['Kod klienta','max_percent']]

    wynik_E1 = wynik_E.rename(columns={'KLIENT': 'Kod klienta'})
    wynik_E1 = wynik_E1[['Kod klienta','max_percent']]

    wynik_L1 = wynik_L.rename(columns={'KLIENT': 'Kod klienta'})
    wynik_L1 = wynik_L1[['Kod klienta','max_percent']]

    wynik_LL1 = wynik_LL.rename(columns={'KLIENT': 'Kod klienta'})
    wynik_LL1 = wynik_LL1[['Kod klienta','max_percent']]

    wynik_R1 = wynik_R.rename(columns={'KLIENT': 'Kod klienta'})
    wynik_R1 = wynik_R1[['Kod klienta','max_percent']]

    wynik_S1 = wynik_S.rename(columns={'KLIENT': 'Kod klienta'})
    wynik_S1 = wynik_S1[['Kod klienta','max_percent']]

    wynik_T1 = wynik_T.rename(columns={'KLIENT': 'Kod klienta'})
    wynik_T1 = wynik_T1[['Kod klienta','max_percent']]

    wynik_TT1 = wynik_TT.rename(columns={'KLIENT': 'Kod klienta'})
    wynik_TT1 = wynik_TT1[['Kod klienta','max_percent']]

    wynik_Z1 = wynik_Z.rename(columns={'KLIENT': 'Kod klienta'})
    wynik_Z1 = wynik_Z1[['Kod klienta','max_percent']]

    wynik_ZZ1 = wynik_ZZ.rename(columns={'KLIENT': 'Kod klienta'})
    wynik_ZZ1 = wynik_ZZ1[['Kod klienta','max_percent']]

    #POŁĄCZYĆ wynik_df z standard_ost
    BRAZOFLAMIN = pd.concat([wynik_B, wynik_B1], axis = 0)
    BRAZOFLAMIN = BRAZOFLAMIN.sort_values(by='max_percent', ascending=False)
    BRAZOFLAMIN = BRAZOFLAMIN.drop_duplicates(subset='Kod klienta')
    

    DIAZEPAM = pd.concat([wynik_D, wynik_D1], axis = 0)
    DIAZEPAM = DIAZEPAM.sort_values(by='max_percent', ascending=False)
    DIAZEPAM = DIAZEPAM.drop_duplicates(subset='Kod klienta')


    ESCITALOPRAM = pd.concat([wynik_E, wynik_E1], axis = 0)
    ESCITALOPRAM = ESCITALOPRAM.sort_values(by='max_percent', ascending=False)
    ESCITALOPRAM = ESCITALOPRAM.drop_duplicates(subset='Kod klienta')


    LEVOFLOXACIN = pd.concat([wynik_L, wynik_L1], axis = 0)
    LEVOFLOXACIN = LEVOFLOXACIN.sort_values(by='max_percent', ascending=False)
    LEVOFLOXACIN = LEVOFLOXACIN.drop_duplicates(subset='Kod klienta')

    
    LEVOFLOXACIN1 = pd.concat([wynik_LL, wynik_LL1], axis = 0)
    LEVOFLOXACIN1 = LEVOFLOXACIN1.sort_values(by='max_percent', ascending=False)
    LEVOFLOXACIN1 = LEVOFLOXACIN1.drop_duplicates(subset='Kod klienta')
    

    RUPATADINE = pd.concat([wynik_R, wynik_R1], axis = 0)
    RUPATADINE = RUPATADINE.sort_values(by='max_percent', ascending=False)
    RUPATADINE = RUPATADINE.drop_duplicates(subset='Kod klienta')


    SILDENAFIL = pd.concat([wynik_S, wynik_S1], axis = 0)
    SILDENAFIL = SILDENAFIL.sort_values(by='max_percent', ascending=False)
    SILDENAFIL = SILDENAFIL.drop_duplicates(subset='Kod klienta')


    TADAXIN = pd.concat([wynik_T, wynik_T1], axis = 0)
    TADAXIN = TADAXIN.sort_values(by='max_percent', ascending=False)
    TADAXIN = TADAXIN.drop_duplicates(subset='Kod klienta')

    TADAXIN1 = pd.concat([wynik_TT, wynik_TT1], axis = 0)
    TADAXIN1 = TADAXIN1.sort_values(by='max_percent', ascending=False)
    TADAXIN1 = TADAXIN1.drop_duplicates(subset='Kod klienta')

    ZOLPIDEM = pd.concat([wynik_Z, wynik_Z1], axis = 0)
    ZOLPIDEM = ZOLPIDEM.sort_values(by='max_percent', ascending=False)
    ZOLPIDEM = ZOLPIDEM.drop_duplicates(subset='Kod klienta')

    ZOLPIDEM1 = pd.concat([wynik_ZZ, wynik_ZZ1], axis = 0)
    ZOLPIDEM1 = ZOLPIDEM1.sort_values(by='max_percent', ascending=False)
    ZOLPIDEM1 = ZOLPIDEM1.drop_duplicates(subset='Kod klienta')


    st.write('Jeśli to pierwszy monitoring, pobierz ten plik, jeśli nie, wrzuć plik z poprzedniego monitoringu i NIE POBIERAJ TEGO PLIKU')
    excel_file = io.BytesIO()

    with pd.ExcelWriter(excel_file, engine='xlsxwriter') as writer:
    # Jeśli dane BRAZOFLAMIN istnieją, zapisz je w odpowiednim arkuszu
        if 'BRAZOFLAMIN' in locals():
            BRAZOFLAMIN.to_excel(writer, index=False, sheet_name='BRAZOFLAMIN')

        # Jeśli dane diazepam istnieją, zapisz je w odpowiednim arkuszu
        if 'DIAZEPAM' in locals():
            DIAZEPAM.to_excel(writer, index=False, sheet_name='DIAZEPAM')

        # Jeśli dane diazepam istnieją, zapisz je w odpowiednim arkuszu
        if 'ESCITALOPRAM' in locals():
            ESCITALOPRAM.to_excel(writer, index=False, sheet_name='ESCITALOPRAM')

        # Jeśli dane diazepam istnieją, zapisz je w odpowiednim arkuszu
        if 'LEVOFLOXACIN' in locals():
            LEVOFLOXACIN.to_excel(writer, index=False, sheet_name='LEVOFLOXACIN GENOPTIM 500MG ')
        
        if 'LEVOFLOXACIN1' in locals():
            LEVOFLOXACIN1.to_excel(writer, index=False, sheet_name='LEVOFLOXACIN GENOPTIM KR.5MG')

        if 'RUPATADINE' in locals():
            RUPATADINE.to_excel(writer, index=False, sheet_name='RUPATADINE')

        if 'SILDENAFIL' in locals():
            SILDENAFIL.to_excel(writer, index=False, sheet_name='SILDENAFIL')

        if 'TADAXIN 5MG' in locals():
            TADAXIN.to_excel(writer, index=False, sheet_name='TADAXIN  5MG')

        if 'TADAXIN 20MG' in locals():
            TADAXIN1.to_excel(writer, index=False, sheet_name='TADAXIN  20MG')

        if 'ZOLPIDEM GENOPTIM 10MG 20TABL.' in locals():
            ZOLPIDEM.to_excel(writer, index=False, sheet_name='ZOLPIDEM GENOPTIM 10MG 20TABL.')

        if 'ZOLPIDEM 10MG 30TABL.' in locals():
            ZOLPIDEM1.to_excel(writer, index=False, sheet_name='ZOLPIDEM 10MG 30TABL.')





    excel_file.seek(0)  # Resetowanie wskaźnika do początku pliku

    # Umożliwienie pobrania pliku Excel
    st.download_button(
        label='Pobierz, jeśli to pierwszy monitoring',
        data=excel_file,
        file_name='czy_dodac.xlsx',
        mime='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    )

    # Plik z poprzedniego monitoringu
    poprzedni = st.file_uploader(
        label="Wrzuć plik z poprzedniego monitoringu"
    )

    if poprzedni:
        xls = pd.ExcelFile(poprzedni)  # Pobranie pliku z arkuszami

    # Wczytanie danych z odpowiednich arkuszy
    if 'BRAZOFLAMIN' in xls.sheet_names:
        poprzedni_brazoflamin = pd.read_excel(poprzedni, sheet_name='BRAZOFLAMIN')
        st.write('Poprzedni monitoring - BRAZOFLAMIN:')
        st.write(poprzedni_brazoflamin.head())
    
    if 'DIAZEPAM' in xls.sheet_names:
        poprzedni_diazepam = pd.read_excel(poprzedni, sheet_name='DIAZEPAM')
        st.write('Poprzedni monitoring - DIAZEPAM:')
        st.write(poprzedni_diazepam.head())

    if 'ESCITALOPRAM' in xls.sheet_names:
        poprzedni_escitalopram = pd.read_excel(poprzedni, sheet_name='ESCITALOPRAM')
        st.write('Poprzedni monitoring - ESCITALOPRAM:')
        st.write(poprzedni_escitalopram.head())

    if 'LEVOFLOXACIN GENOPTIM 500MG ' in xls.sheet_names:
        poprzedni_levofloxacin = pd.read_excel(poprzedni, sheet_name='LEVOFLOXACIN GENOPTIM 500MG ')
        st.write('Poprzedni monitoring - LEVOFLOXACIN GENOPTIM 500MG :')
        st.write(poprzedni_levofloxacin.head())

    if 'LEVOFLOXACIN GENOPTIM KR.5MG' in xls.sheet_names:
        poprzedni_levofloxacin1 = pd.read_excel(poprzedni, sheet_name='LEVOFLOXACIN GENOPTIM KR.5MG')
        st.write('Poprzedni monitoring - LEVOFLOXACIN GENOPTIM KR.5MG :')
        st.write(poprzedni_levofloxacin1.head())

    if 'RUPATADINE' in xls.sheet_names:
        poprzedni_rupatadine = pd.read_excel(poprzedni, sheet_name='RUPATADINE')
        st.write('Poprzedni monitoring - RUPATADINE:')
        st.write(poprzedni_rupatadine.head())

    if 'SILDENAFIL' in xls.sheet_names:
        poprzedni_sildenafil = pd.read_excel(poprzedni, sheet_name='SILDENAFIL')
        st.write('Poprzedni monitoring - SILDENAFIL:')
        st.write(poprzedni_sildenafil.head())

    if 'TADAXIN 5MG' in xls.sheet_names:
        poprzedni_tadaxin = pd.read_excel(poprzedni, sheet_name='TADAXIN 5MG')
        st.write('Poprzedni monitoring - TADAXIN 5MG:')
        st.write(poprzedni_tadaxin.head())

    if 'TADAXIN 20MG' in xls.sheet_names:
        poprzedni_tadaxin1 = pd.read_excel(poprzedni, sheet_name='TADAXIN 20MG')
        st.write('Poprzedni monitoring - TADAXIN 20MG:')
        st.write(poprzedni_tadaxin1.head())

    if 'ZOLPIDEM GENOPTIM 10MG 20TABL.' in xls.sheet_names:
        poprzedni_zolpidem = pd.read_excel(poprzedni, sheet_name='ZOLPIDEM GENOPTIM 10MG 20TABL.')
        st.write('Poprzedni monitoring - ZOLPIDEM GENOPTIM 10MG 20TABL.:')
        st.write(poprzedni_zolpidem.head())

    if 'ZOLPIDEM 10MG 30TABL.' in xls.sheet_names:
        poprzedni_zolpidem1 = pd.read_excel(poprzedni, sheet_name='ZOLPIDEM 10MG 30TABL.')
        st.write('Poprzedni monitoring - ZOLPIDEM 10MG 30TABL.')
        st.write(poprzedni_zolpidem1.head())



    # Przetwarzanie dla BRAZOFLAMIN
    if 'BRAZOFLAMIN' in locals() and 'poprzedni_brazoflamin' in locals():
        poprzedni_brazoflamin = poprzedni_brazoflamin.rename(columns={'max_percent': 'old_percent'})
        result_brazoflamin = BRAZOFLAMIN.merge(poprzedni_brazoflamin[['Kod klienta', 'old_percent']], on='Kod klienta', how='left')
        result_brazoflamin['old_percent'] = result_brazoflamin['old_percent'].fillna(0)
        result_brazoflamin['Czy dodać'] = result_brazoflamin.apply(lambda row: 'DODAJ' if row['max_percent'] > row['old_percent'] else '', axis=1)
    
    # Przetwarzanie dla DIAZEPAM
    if 'DIAZEPAM' in locals() and 'poprzedni_diazepam' in locals():
        poprzedni_diazepam = poprzedni_diazepam.rename(columns={'max_percent': 'old_percent'})
        result_diazepam = DIAZEPAM.merge(poprzedni_diazepam[['Kod klienta', 'old_percent']], on='Kod klienta', how='left')
        result_diazepam['old_percent'] = result_diazepam['old_percent'].fillna(0)
        result_diazepam['Czy dodać'] = result_diazepam.apply(lambda row: 'DODAJ' if row['max_percent'] > row['old_percent'] else '', axis=1)
  

    # Przetwarzanie dla ESCITALOPRAM
    if 'ESCITALOPRAM' in locals() and 'poprzedni_escitalopram' in locals():
        poprzedni_escitalopram = poprzedni_escitalopram.rename(columns={'max_percent': 'old_percent'})
        result_escitalopram = ESCITALOPRAM.merge(poprzedni_escitalopram[['Kod klienta', 'old_percent']], on='Kod klienta', how='left')
        result_escitalopram['old_percent'] = result_escitalopram['old_percent'].fillna(0)
        result_escitalopram['Czy dodać'] = result_escitalopram.apply(lambda row: 'DODAJ' if row['max_percent'] > row['old_percent'] else '', axis=1)

    if 'LEVOFLOXACIN' in locals() and 'poprzedni_levofloxacin' in locals():
        poprzedni_levofloxacin = poprzedni_levofloxacin.rename(columns={'max_percent': 'old_percent'})
        result_levofloxacin = LEVOFLOXACIN.merge(poprzedni_levofloxacin[['Kod klienta', 'old_percent']], on='Kod klienta', how='left')
        result_levofloxacin['old_percent'] = result_levofloxacin['old_percent'].fillna(0)
        result_levofloxacin['Czy dodać'] = result_levofloxacin.apply(lambda row: 'DODAJ' if row['max_percent'] > row['old_percent'] else '', axis=1)

        # Przetwarzanie dla ESCITALOPRAM
    if 'LEVOFLOXACIN1' in locals() and 'poprzedni_levofloxacin1' in locals():
        poprzedni_levofloxacin1 = poprzedni_levofloxacin1.rename(columns={'max_percent': 'old_percent'})
        result_levofloxacin1 = LEVOFLOXACIN1.merge(poprzedni_levofloxacin1[['Kod klienta', 'old_percent']], on='Kod klienta', how='left')
        result_levofloxacin1['old_percent'] = result_levofloxacin1['old_percent'].fillna(0)
        result_levofloxacin1['Czy dodać'] = result_levofloxacin1.apply(lambda row: 'DODAJ' if row['max_percent'] > row['old_percent'] else '', axis=1)

    if 'RUPATADINE' in locals() and 'poprzedni_rupatadine' in locals():
        poprzedni_rupatadine = poprzedni_rupatadine.rename(columns={'max_percent': 'old_percent'})
        result_rupatadine = RUPATADINE.merge(poprzedni_rupatadine[['Kod klienta', 'old_percent']], on='Kod klienta', how='left')
        result_rupatadine['old_percent'] = result_rupatadine['old_percent'].fillna(0)
        result_rupatadine['Czy dodać'] = result_rupatadine.apply(lambda row: 'DODAJ' if row['max_percent'] > row['old_percent'] else '', axis=1)

    
    if 'SILDENAFIL' in locals() and 'poprzedni_sildenafil' in locals():
        poprzedni_sildenafil = poprzedni_sildenafil.rename(columns={'max_percent': 'old_percent'})
        result_sildenafil = SILDENAFIL.merge(poprzedni_sildenafil[['Kod klienta', 'old_percent']], on='Kod klienta', how='left')
        result_sildenafil['old_percent'] = result_sildenafil['old_percent'].fillna(0)
        result_sildenafil['Czy dodać'] = result_sildenafil.apply(lambda row: 'DODAJ' if row['max_percent'] > row['old_percent'] else '', axis=1)

    if 'TADAXIN' in locals() and 'poprzedni_tadaxin' in locals():
        poprzedni_tadaxin = poprzedni_tadaxin.rename(columns={'max_percent': 'old_percent'})
        result_tadaxin = TADAXIN.merge(poprzedni_tadaxin[['Kod klienta', 'old_percent']], on='Kod klienta', how='left')
        result_tadaxin['old_percent'] = result_tadaxin['old_percent'].fillna(0)
        result_tadaxin['Czy dodać'] = result_tadaxin.apply(lambda row: 'DODAJ' if row['max_percent'] > row['old_percent'] else '', axis=1)

    if 'TADAXIN1' in locals() and 'poprzedni_tadaxin1' in locals():
        poprzedni_tadaxin1 = poprzedni_tadaxin1.rename(columns={'max_percent': 'old_percent'})
        result_tadaxin1 = TADAXIN1.merge(poprzedni_tadaxin1[['Kod klienta', 'old_percent']], on='Kod klienta', how='left')
        result_tadaxin1['old_percent'] = result_tadaxin1['old_percent'].fillna(0)
        result_tadaxin1['Czy dodać'] = result_tadaxin1.apply(lambda row: 'DODAJ' if row['max_percent'] > row['old_percent'] else '', axis=1)

    if 'ZOLPIDEM' in locals() and 'poprzedni_zolpidem' in locals():
        poprzedni_zolpidem = poprzedni_zolpidem.rename(columns={'max_percent': 'old_percent'})
        result_zolpidem = ZOLPIDEM.merge(poprzedni_zolpidem[['Kod klienta', 'old_percent']], on='Kod klienta', how='left')
        result_zolpidem['old_percent'] = result_zolpidem['old_percent'].fillna(0)
        result_zolpidem['Czy dodać'] = result_zolpidem.apply(lambda row: 'DODAJ' if row['max_percent'] > row['old_percent'] else '', axis=1)

    if 'ZOLPIDEM1' in locals() and 'poprzedni_zolpidem1' in locals():
        poprzedni_zolpidem1 = poprzedni_zolpidem1.rename(columns={'max_percent': 'old_percent'})
        result_zolpidem1 = ZOLPIDEM1.merge(poprzedni_zolpidem1[['Kod klienta', 'old_percent']], on='Kod klienta', how='left')
        result_zolpidem1['old_percent'] = result_zolpidem1['old_percent'].fillna(0)
        result_zolpidem1['Czy dodać'] = result_zolpidem1.apply(lambda row: 'DODAJ' if row['max_percent'] > row['old_percent'] else '', axis=1)




    # Zapisywanie plików do Excela
    excel_file1 = io.BytesIO()
    with pd.ExcelWriter(excel_file1, engine='xlsxwriter') as writer:
        if 'result_brazoflamin' in locals():
            result_brazoflamin.to_excel(writer, index=False, sheet_name='BRAZOFLAMIN')
        if 'result_diazepam' in locals():
            result_diazepam.to_excel(writer, index=False, sheet_name='DIAZEPAM')
        if 'result_escitalopram' in locals():
            result_escitalopram.to_excel(writer, index=False, sheet_name='ESCITALOPRAM')
        if 'result_levofloxacin' in locals():
            result_levofloxacin.to_excel(writer, index=False, sheet_name='LEVOFLOXACIN GENOPTIM 500MG ')
        if 'result_levofloxacin1' in locals():
            result_levofloxacin1.to_excel(writer, index=False, sheet_name='LEVOFLOXACIN GENOPTIM KR.5MG')
        if 'result_rupatadine' in locals():
            result_rupatadine.to_excel(writer, index=False, sheet_name='RUPATADINE')
        if 'result_sildenafil' in locals():
            result_sildenafil.to_excel(writer, index=False, sheet_name='SILDENAFIL')
        if 'result_tadaxin' in locals():
            result_tadaxin.to_excel(writer, index=False, sheet_name='TADAXIN 5MG')
        if 'result_tadaxin1' in locals():
            result_tadaxin1.to_excel(writer, index=False, sheet_name='TADAXIN 20MG')
        if 'result_zolpidem' in locals():
            result_zolpidem.to_excel(writer, index=False, sheet_name='ZOLPIDEM GENOPTIM 10MG 20TABL.')
        if 'result_zolpidem1' in locals():
            result_zolpidem1.to_excel(writer, index=False, sheet_name='ZOLPIDEM 10MG 30TABL.')


    excel_file1.seek(0)  # Resetowanie wskaźnika do początku pliku

    # Definiowanie nazwy pliku
    nazwa_pliku = f"GENOPTIM_{dzisiejsza_data}.xlsx"
    # Umożliwienie pobrania pliku Excel
    st.download_button(
        label='Kliknij aby pobrać plik z kodami, które kody należy dodać',
        data=excel_file1,
        file_name=nazwa_pliku,
        mime='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    )
   


    result_brazoflamin = result_brazoflamin.drop(columns=['old_percent', 'Czy dodać'])
    result_diazepam = result_diazepam.drop(columns=['old_percent', 'Czy dodać'])
    result_escitalopram = result_escitalopram.drop(columns=['old_percent', 'Czy dodać'])
    result_levofloxacin = result_levofloxacin.drop(columns=['old_percent', 'Czy dodać'])
    result_levofloxacin1 = result_levofloxacin1.drop(columns=['old_percent', 'Czy dodać'])
    result_rupatadine = result_rupatadine.drop(columns=['old_percent', 'Czy dodać'])
    result_sildenafil = result_sildenafil.drop(columns=['old_percent', 'Czy dodać'])
    result_tadaxin = result_tadaxin.drop(columns=['old_percent', 'Czy dodać'])
    result_tadaxin1 = result_tadaxin1.drop(columns=['old_percent', 'Czy dodać'])
    result_zolpidem = result_zolpidem.drop(columns=['old_percent', 'Czy dodać'])
    result_zolpidem1 = result_zolpidem1.drop(columns=['old_percent', 'Czy dodać'])



    st.write('Kliknij, aby pobrać plik z formułą max do następnego monitoringu')

    # Tworzenie pliku Excel w pamięci
    excel_file2 = io.BytesIO()

    # Zapis do pliku Excel w pamięci
    with pd.ExcelWriter(excel_file2, engine='xlsxwriter') as writer:
        result_brazoflamin.to_excel(writer, index=False, sheet_name='BRAZOFLAMIN')
        result_diazepam.to_excel(writer, index=False, sheet_name='DIAZEPAM')
        result_escitalopram.to_excel(writer, index=False, sheet_name='ESCITALOPRAM')
        result_levofloxacin.to_excel(writer, index=False, sheet_name='LEVOFLOXACIN GENOPTIM 500MG ')
        result_levofloxacin1.to_excel(writer, index=False, sheet_name='LEVOFLOXACIN GENOPTIM KR.5MG')
        result_rupatadine.to_excel(writer, index=False, sheet_name='RUPATADINE')
        result_sildenafil.to_excel(writer, index=False, sheet_name='SILDENAFIL')
        result_tadaxin.to_excel(writer, index=False, sheet_name='TADAXIN 5MG')
        result_tadaxin1.to_excel(writer, index=False, sheet_name='TADAXIN 20MG')
        result_zolpidem.to_excel(writer, index=False, sheet_name='ZOLPIDEM GENOPTIM 10MG 20TABL.')
        result_zolpidem1.to_excel(writer, index=False, sheet_name='ZOLPIDEM 10MG 30TABL.')

    # Resetowanie wskaźnika do początku pliku
    excel_file2.seek(0) 

    # Definiowanie nazwy pliku
    nazwa_pliku = f"FM_GENOPTIM_{dzisiejsza_data}.xlsx"

    # Umożliwienie pobrania pliku Excel
    st.download_button(
        label='Pobierz nowy plik FORMUŁA MAX',
        data=excel_file2,
        file_name=nazwa_pliku,
        mime='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    )





    
    























    
